<!-- 
  Player Control HUD (PCH) - 模板文件
  版本: Final (包含护体修复、怒气对齐、架招提示优化)
-->
<div id="xjzl-player-hud">

    <!-- 1. 左翼：战阵四维 -->
    <div class="hud-wing left">
        <div class="combat-stat-grid">
            {{#each leftStats}}
            <div class="c-stat" data-tooltip="{{label}}">
                <span class="label">{{label}}</span>
                <span class="val">{{value}}</span>
            </div>
            {{/each}}
        </div>
    </div>

    <!-- 2. 中庭：本我 -->
    <div class="hud-center">

        <!-- 架招 Badge (顶端悬浮) -->
        {{#if stanceName}}
        <!-- 这里的 stanceDesc 已经在 JS 里拼好了“点击解除”的提示 -->
        <div class="stance-badge" data-action="stop-stance" data-tooltip="{{stanceDesc}}" data-tooltip-direction="UP">
            <i class="fas fa-shield-alt"></i> {{stanceName}}
        </div>
        {{/if}}

        <!-- 核心立绘容器 -->
        <div class="avatar-wrapper">
            <!-- 头像框 (点击打开角色卡) -->
            <div class="avatar-frame clickable" data-action="open-sheet" data-tooltip="点击打开角色面板">
                <img src="{{actorImg}}" class="avatar-img">
                <!-- 内功呼吸光环 -->
                <div class="aura-ring {{neigongElement}}"></div>
            </div>

            <!-- 境界印章 -->
            {{#if realmName}}
            <div class="realm-seal" data-tooltip="当前境界">{{realmName}}</div>
            {{/if}}

            <!-- 怒气环绕 (半圆排列) -->
            <div class="rage-ring-container">
                {{#each rageDots}}
                <div class="rage-orb {{#if this.active}}active{{/if}}" style="--i:{{@index}}"></div>
                {{/each}}
            </div>

            <!-- 怒气核心 (底部输入框) -->
            <div class="rage-core" data-tooltip="当前怒气">
                <i class="fas fa-fire"></i>
                <input type="text" class="res-input rage-input" data-target="system.resources.rage.value"
                    value="{{rage.value}}">
            </div>
        </div>

        <!-- 折叠/展开按钮 -->
        <div class="toggle-hud-btn" data-action="toggle-collapse" data-tooltip="折叠/展开 HUD">
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>

    <!-- 3. 右翼：气血内力 -->
    <div class="hud-wing right">

        <!-- HP组: 使用 group 包裹，护体徽章外置防止截断 -->
        <div class="bar-group">

            <!-- 护体数值徽章 (浮动在上方) -->
            {{#if hutiValue}}
            <div class="huti-badge" data-tooltip="护体真气">
                <i class="fas fa-shield-alt"></i>
                <input type="text" class="res-input huti-input" data-target="system.resources.huti"
                    value="{{hutiValue}}">
            </div>
            {{/if}}

            <!-- HP 条本体 -->
            <div class="res-bar hp">
                <div class="bar-fill" style="width: {{hpPercent}}%;"></div>
                <!-- 护体光罩 -->
                <div class="bar-shield" style="width: {{hutiPercent}}%;"></div>
                <div class="bar-text">
                    <input type="text" class="res-input" data-target="system.resources.hp.value" value="{{hp.value}}">
                    <span class="sep">/</span>
                    <span class="max">{{hp.max}}</span>
                </div>
            </div>
        </div>

        <!-- MP 条 -->
        <div class="res-bar mp">
            <div class="bar-fill" style="width: {{mpPercent}}%;"></div>
            <div class="bar-text">
                <input type="text" class="res-input" data-target="system.resources.mp.value" value="{{mp.value}}">
                <span class="sep">/</span>
                <span class="max">{{mp.max}}</span>
            </div>
        </div>
    </div>

    <!-- 4. 底座：万象森罗 (操作按钮) -->
    <div class="hud-dock">
        <!-- 常用招式 -->
        <div class="dock-category">
            <div class="cat-btn" data-tooltip="常用招式"><i class="fas fa-fist-raised"></i></div>
            <div class="cat-content">
                <div class="scroll-area">
                    {{#each shortcuts}}
                    <div class="item-btn move" data-action="use-move" data-item-id="{{item.id}}"
                        data-move-id="{{move.id}}"
                        data-tooltip="<div style='text-align:left'><strong>{{move.name}}</strong><br><span style='color:#aaa'>{{item.name}}</span><hr><i class='fas fa-mouse-pointer'></i> 左键: 出招<br><i class='fas fa-comment-dots'></i> 右键: 发送</div>">
                        <img src="{{item.img}}">
                        <span class="label">{{move.name}}</span>
                    </div>
                    {{/each}}
                    {{#unless shortcuts}}
                    <div class="empty-tip">无常用招式</div>
                    {{/unless}}
                </div>
            </div>
        </div>

        <!-- 消耗品 -->
        <div class="dock-category">
            <div class="cat-btn" data-tooltip="消耗品"><i class="fas fa-flask"></i></div>
            <div class="cat-content">
                <div class="scroll-area">
                    {{#each consumables}}
                    <div class="item-btn" data-action="use-item" data-item-id="{{id}}"
                        data-tooltip="<div style='text-align:left'><strong>{{name}}</strong><br>数量: {{system.quantity}}<hr><i class='fas fa-mouse-pointer'></i> 左键: 使用<br><i class='fas fa-comment-dots'></i> 右键: 发送</div>">
                        <img src="{{img}}">
                        <span class="qty">{{system.quantity}}</span>
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>

        <!-- 装备 -->
        <div class="dock-category">
            <div class="cat-btn" data-tooltip="装备"><i class="fas fa-tshirt"></i></div>
            <div class="cat-content">
                <div class="scroll-area">
                    {{#each equipments}}
                    <div class="item-btn {{#if system.equipped}}equipped{{/if}}" data-action="toggle-equip"
                        data-item-id="{{id}}"
                        data-tooltip="<div style='text-align:left'><strong>{{name}}</strong><hr><i class='fas fa-mouse-pointer'></i> 左键: 穿戴<br><i class='fas fa-comment-dots'></i> 右键: 发送</div>">
                        <img src="{{img}}">
                        {{#if system.equipped}}<i class="fas fa-check equip-mark"></i>{{/if}}
                    </div>
                    {{/each}}
                </div>
            </div>
        </div>

        <!-- 属性检定 -->
        <div class="dock-category">
            <div class="cat-btn" data-tooltip="属性/技能"><i class="fas fa-dice-d20"></i></div>
            <div class="cat-content">
                <div class="attr-grid">
                    {{#each stats}}
                    <div class="attr-btn" data-action="roll-stat" data-key="{{key}}">{{label}}</div>
                    {{/each}}
                    <div class="attr-btn skill" data-action="roll-stat" data-key="qinggong">轻功</div>
                    <div class="attr-btn skill" data-action="roll-stat" data-key="jianding">鉴定</div>
                    <div class="attr-btn skill" data-action="roll-stat" data-key="tancha">探查</div>
                </div>
            </div>
        </div>
    </div>
</div>